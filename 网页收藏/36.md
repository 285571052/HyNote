<div>
<h2 id="引言">引言</h2> <p>你是否：</p>
<ul>
<li>好奇过命令行里那些花里胡哨的进度条是如何实现的？</li>
<li>好奇过Spring Boot为什么能够打印五颜六色的日志？</li>
<li>好奇过Python或者PHP等脚本语言的交互式命令行是如何实现的？</li>
<li>好奇过Vim或者Emacs等在Terminal中的编辑器是怎么实现的？</li>
</ul>
<p>如果你曾经好奇过，或者被这段话勾起了你的好奇心，那么你绝对不能错过这篇文章！</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>通过本文你可以学到：</p>
<ol>
<li>何为Ansi Escape Codes以及它们能干什么？</li>
<li>Ansi Escape Codes的一些高级应用。</li>
<li>JDK9中Jshell的使用。</li>
</ol>
<p>事先声明，本文主要参考：<a href="http://www.lihaoyi.com/post/BuildyourownCommandLinewithANSIescapecodes.html" target="_blank" rel="external">http://www.lihaoyi.com/post/BuildyourownCommandLinewithANSIescapecodes.html</a>。原文思路清晰，案例生动形象，排版优秀，实为良心之作。但是由于原文是用英语书写且用Python作为演示，所以本后端小菜鸡不要脸地将其翻译一遍，并且用JDK9的Jshell做演示，方便广大的Javaer学习。</p>
<p>本文所有的代码已经推到Github中，地址为：<a href="https://github.com/Lovelcp/blog-demos/tree/master/ansi-escape-codes-tutorial" target="_blank" rel="external">https://github.com/Lovelcp/blog-demos/tree/master/ansi-escape-codes-tutorial</a>。强烈建议大家将代码clone下来跑一下看看效果，加深自己的印象。</p>
<a id="more"></a>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li>Mac或Linux或者WIn10操作系统。<strong>除了Win10之外的Windows系统暂时不支持Ansi Escape Codes。</strong></li>
<li>因为本文采用Jshell作为演示工具，所以大家需要安装最近刚正式发布的JDK9。</li>
</ul>
<p>OK！一切准备就绪，让我们开始吧！</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-11-23-104617.png" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-11-23-104617.png" alt=""></a></p>
<h2 id="富文本"><a href="#富文本" class="headerlink" title="富文本"></a>富文本</h2><p>Ansi Escape Codes最基础的用途就是让控制台显示的文字以富文本的形式输出，比如设置字体颜色、背景颜色以及各种样式。让我们先来学习如何设置字体颜色，而不用再忍受那枯燥的黑白二色！</p>
<h3 id="字体颜色"><a href="#字体颜色" class="headerlink" title="字体颜色"></a>字体颜色</h3><p>通过Ansi指令（即Ansi Escape Codes）给控制台的文字上色是最为常见的操作。比如：</p>
<ul>
<li>红色：<code>\u001b[31m</code></li>
<li>重置：<code>\u001b[0m</code></li>
</ul>
<p>绝大部分Ansi Escape Codes都以<code>\u001b</code>开头。让我们通过Java代码来输出一段红色的<code>Hello World</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[31mHello World"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-121113.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-121113.jpg" alt=""></a></p>
<p>从上图中，我们可以看到，不仅<code>Hello World</code>是变成了红色，而且接下来的<code>jshell&gt;</code>提示符也变成了红色。其实不管你接下来输入什么字符，它们的字体颜色都是红色。直到你输入了其他颜色的Ansi指令，或者输入了重置指令，字体的颜色才会不再是红色。</p>
<p>让我们尝试输入重置指令来恢复字体的颜色：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[0m"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-121219.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-121219.jpg" alt=""></a></p>
<p>很好！<code>jshell&gt;</code>提示符恢复为了白色。所以一个最佳实践就是，最好在所有改变字体颜色或者样式的Ansi Escape Codes的最后加上重置指令，以免造成意想不到的后果。举个例子：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[31mHello World\u001b[0m"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-121417.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-121417.jpg" alt=""></a></p>
<p>当然，重置指令可以被添加在任何位置，比如我们可以将其插在<code>Hello World</code>的中间，使得<code>Hello</code>是红色，但是<code>World</code>是白色：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[31mHello\u001b[0m World"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-121613.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-121613.jpg" alt=""></a></p>
<h4 id="8色"><a href="#8色" class="headerlink" title="8色"></a>8色</h4><p>刚才我们介绍了<code>红色</code>以及<code>重置</code>命令。基本上所有的控制台都支持以下8种颜色：</p>
<ul>
<li>黑色：<code>\u001b[30m</code></li>
<li>红色：<code>\u001b[31m</code></li>
<li>绿色：<code>\u001b[32m</code></li>
<li>黄色：<code>\u001b[33m</code></li>
<li>蓝色：<code>\u001b[34m</code></li>
<li>洋红色：<code>\u001b[35m</code></li>
<li>青色：<code>\u001b[36m</code></li>
<li>白色：<code>\u001b[37m</code></li>
<li>重置：<code>\u001b[0m</code></li>
</ul>
<p>不如将它们都输出看一下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[30m A \u001b[31m B \u001b[32m C \u001b[33m D \u001b[0m"</span>);</div><div class="line">System.out.print(<span class="string">"\u001b[34m E \u001b[35m F \u001b[36m G \u001b[37m H \u001b[0m"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-124044.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-124044.jpg" alt=""></a></p>
<p>注意，<code>A</code>因为是黑色所以与控制台融为一体了。</p>
<h4 id="16色"><a href="#16色" class="headerlink" title="16色"></a>16色</h4><p>大多数的控制台，除了支持刚才提到的8色外，还可以输出在此之上更加明亮的8种颜色：</p>
<ul>
<li>亮黑色：<code>\u001b[30;1m</code></li>
<li>亮红色：<code>\u001b[31;1m</code></li>
<li>亮绿色：<code>\u001b[32;1m</code></li>
<li>亮黄色：<code>\u001b[33;1m</code></li>
<li>亮蓝色：<code>\u001b[34;1m</code></li>
<li>亮洋红色：<code>\u001b[35;1m</code></li>
<li>亮青色：<code>\u001b[36;1m</code></li>
<li>亮白色：<code>\u001b[37;1m</code></li>
</ul>
<p>亮色指令分别在原来对应颜色的指令中间加上<code>;1</code>。我们将所有的16色在控制台打印，方便大家进行比对：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[30m A \u001b[31m B \u001b[32m C \u001b[33m D \u001b[0m"</span>);</div><div class="line">System.out.print(<span class="string">"\u001b[34m E \u001b[35m F \u001b[36m G \u001b[37m H \u001b[0m"</span>);</div><div class="line">System.out.print(<span class="string">"\u001b[30;1m A \u001b[31;1m B \u001b[32;1m C \u001b[33;1m D \u001b[0m"</span>);</div><div class="line">System.out.print(<span class="string">"\u001b[34;1m E \u001b[35;1m F \u001b[36;1m G \u001b[37;1m H \u001b[0m"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-124455.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-124455.jpg" alt=""></a></p>
<p>从图中我们可以清晰地看到，下面的8色比上面的8色显得更加明亮。比如，原来黑色的<code>A</code>，在黑色的控制台背景下，几乎无法看到，但是一旦通过亮黑色输出后，对比度变得更高，变得更好辨识了。</p>
<h4 id="256色"><a href="#256色" class="headerlink" title="256色"></a>256色</h4><p>最后，除了16色外，某些控制台支持输出256色。指令的形式如下：</p>
<ul>
<li><code>\u001b[38;5;${ID}m</code></li>
</ul>
<p>让我们输出256色矩阵：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) {</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) {</div><div class="line">        <span class="keyword">int</span> code = i * <span class="number">16</span> + j;</div><div class="line">        System.out.printf(<span class="string">"\u001b[38;5;%dm%-4d"</span>, code, code);</div><div class="line">    }</div><div class="line">    System.out.println(<span class="string">"\u001b[0m"</span>);</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-130859.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-130859.jpg" alt=""></a></p>
<p>关于字体颜色我们就介绍到这，接下来我们来介绍背景色。</p>
<h3 id="背景颜色"><a href="#背景颜色" class="headerlink" title="背景颜色"></a>背景颜色</h3><p>刚才所说的字体颜色可以统称为前景色（foreground color）。那么理所当然，我们可以设置文本的背景颜色：</p>
<ul>
<li>黑色背景：<code>\u001b[40m</code></li>
<li>红色背景：<code>\u001b[41m</code></li>
<li>绿色背景：<code>\u001b[42m</code></li>
<li>黄色背景：<code>\u001b[43m</code></li>
<li>蓝色背景：<code>\u001b[44m</code></li>
<li>洋红色背景：<code>\u001b[45m</code></li>
<li>青色背景：<code>\u001b[46m</code></li>
<li>白色背景：<code>\u001b[47m</code></li>
</ul>
<p>对应的亮色版本：</p>
<ul>
<li>亮黑色背景：<code>\u001b[40;1m</code></li>
<li>亮红色背景：<code>\u001b[41;1m</code></li>
<li>亮绿色背景：<code>\u001b[42;1m</code></li>
<li>亮黄色背景：<code>\u001b[43;1m</code></li>
<li>亮蓝色背景：<code>\u001b[44;1m</code></li>
<li>亮洋红色背景：<code>\u001b[45;1m</code></li>
<li>亮青色背景：<code>\u001b[46;1m</code></li>
<li>亮白色背景：<code>\u001b[47;1m</code></li>
</ul>
<p>首先让我们看看16色背景：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[40m A \u001b[41m B \u001b[42m C \u001b[43m D \u001b[0m"</span>);</div><div class="line">System.out.print(<span class="string">"\u001b[44m A \u001b[45m B \u001b[46m C \u001b[47m D \u001b[0m"</span>);</div><div class="line">System.out.print(<span class="string">"\u001b[40;1m A \u001b[41;1m B \u001b[42;1m C \u001b[43;1m D \u001b[0m"</span>);</div><div class="line">System.out.print(<span class="string">"\u001b[44;1m A \u001b[45;1m B \u001b[46;1m C \u001b[47;1m D \u001b[0m"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-131845.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-131845.jpg" alt=""></a></p>
<p>值得注意的是，亮色背景并不是背景颜色显得更加明亮，而是让对应的前景色显得更加明亮。虽然这点有点不太直观，但是实际表现就是如此。</p>
<p>让我们再来试试256背景色，首先指令如下：</p>
<ul>
<li><code>\u001b[48;5;${ID}m</code></li>
</ul>
<p>同样输出256色矩阵：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) {</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) {</div><div class="line">        <span class="keyword">int</span> code = i * <span class="number">16</span> + j;</div><div class="line">        System.out.printf(<span class="string">"\u001b[48;5;%dm%-4d"</span>, code, code);</div><div class="line">    }</div><div class="line">    System.out.println(<span class="string">"\u001b[0m"</span>);</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-132045.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-132045.jpg" alt=""></a></p>
<p>感觉要被亮瞎眼了呢！至此，颜色设置已经介绍完毕，让我们接着学习样式设置。</p>
<h3 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h3><p>除了给文本设置颜色之外，我们还可以给文本设置样式：</p>
<ul>
<li>粗体：<code>\u001b[1m</code></li>
<li>下划线：<code>\u001b[4m</code></li>
<li>反色：<code>\u001b[7m</code></li>
</ul>
<p>样式分别使用的效果：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[1m BOLD \u001b[0m\u001b[4m Underline \u001b[0m\u001b[7m Reversed \u001b[0m"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-132236.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-132236.jpg" alt=""></a></p>
<p>或者结合使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[1m\u001b[4m\u001b[7m BOLD Underline Reversed \u001b[0m"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-132335.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-132335.jpg" alt=""></a></p>
<p>甚至还可以和颜色结合使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">System.out.print(<span class="string">"\u001b[1m\u001b[31m Red Bold \u001b[0m"</span>);</div><div class="line">System.out.print(<span class="string">"\u001b[4m\u001b[44m Blue Background Underline \u001b[0m"</span>);</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-132503.jpg" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-132503.jpg" alt=""></a></p>
<p>是不是很简单，是不是很酷！学会了这些，我们已经能够写出十分酷炫的命令行脚本了。但是如果要实现更复杂的功能（比如进度条），我们还需要掌握更加牛逼的光标控制指令！</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-11-23-113419.png" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-11-23-113419.png" alt=""></a></p>
<h2 id="光标控制"><a href="#光标控制" class="headerlink" title="光标控制"></a>光标控制</h2><p>Ansi Escape Code里更加复杂的指令就是光标控制。通过这些指令，我们可以自由地移动我们的光标至屏幕的任何位置。比如在Vim的命令模式下，我们可以使用<code>H/J/K/L</code>这四个键实现光标的上下左右移动。</p>
<p>最基础的光标控制指令如下：</p>
<ul>
<li>上：<code>\u001b[{n}A</code></li>
<li>下：<code>\u001b[{n}B</code></li>
<li>右：<code>\u001b[{n}C</code></li>
<li>左：<code>\u001b[{n}D</code></li>
</ul>
<p>通过光标控制的特性，我们能够实现大量有趣且酷炫的功能。首先我们来看看怎么实现一个进度条。</p>
<h3 id="进度数字显示"><a href="#进度数字显示" class="headerlink" title="进度数字显示"></a>进度数字显示</h3><p>作为进度条，怎么可以没有进度数字显示呢？所以我们先来实现进度条进度数字的刷新：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">loading</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>{</div><div class="line">    System.out.println(<span class="string">"Loading..."</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) {</div><div class="line">        Thread.sleep(<span class="number">100</span>);</div><div class="line">        System.out.print(<span class="string">"\u001b[1000D"</span> + i + <span class="string">"%"</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-loading_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-loading_gif.gif" alt=""></a></p>
<p>从图中我们可以看到，进度在同一行从1%不停地刷新到100%。为了进度只在同一行显示，我们在代码中使用了<code>System.out.print</code>而不是<code>System.out.println</code>。在打印每个进度之前，我们使用了<code>\u001b[1000D</code>指令，目的是为了将光标移动到当前行的最左边也就是行首。然后重新打印新的进度，新的进度数字会覆盖刚才的进度数字，循环往复，这就实现了上图的效果。</p>
<blockquote>
<p>PS：<code>\u001b[1000D</code>表示将光标往左移动1000个字符。这里的1000表示光标移动的距离，只要你能够确保光标能够移动到最左端，随便设置多少比如设置2000都可以。</p>
</blockquote>
<p>为了方便大家更加轻松地理解光标的移动过程，让我们放慢进度条刷新的频率：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">loading</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>{</div><div class="line">    System.out.println(<span class="string">"Loading..."</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) {</div><div class="line">        System.out.print(<span class="string">"\u001b[1000D"</span>);</div><div class="line">        Thread.sleep(<span class="number">1000</span>);</div><div class="line">        System.out.print(i + <span class="string">"%"</span>);</div><div class="line">        Thread.sleep(<span class="number">1000</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-slow_loading_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-slow_loading_gif.gif" alt=""></a></p>
<p>现在我们可以清晰地看到：</p>
<ol>
<li>从左到右打印进度，光标移至行尾。</li>
<li>光标移至行首，原进度数字还在。</li>
<li>从左到右打印新进度，新的数字会覆盖老的数字。光标移至行尾。</li>
<li>循环往复。</li>
</ol>
<h3 id="Ascii进度条"><a href="#Ascii进度条" class="headerlink" title="Ascii进度条"></a>Ascii进度条</h3><p>好了，我们现在已经知道如何通过Ansi Escape Code实现进度数字的显示和刷新，剩下的就是实现进度的读条。废话不多说，我们直接上代码和效果图：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">loading</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>{</div><div class="line">    System.out.println(<span class="string">"Loading..."</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) {</div><div class="line">        <span class="keyword">int</span> width = i / <span class="number">4</span>;</div><div class="line">        String left = <span class="string">"["</span> + String.join(<span class="string">""</span>, Collections.nCopies(width, <span class="string">"#"</span>));</div><div class="line">        String right = String.join(<span class="string">""</span>, Collections.nCopies(<span class="number">25</span> - width, <span class="string">" "</span>)) + <span class="string">"]"</span>;</div><div class="line">        System.out.print(<span class="string">"\u001b[1000D"</span> + left + right);</div><div class="line">        Thread.sleep(<span class="number">100</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-ascii_bar_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-23-ascii_bar_gif.gif" alt=""></a></p>
<p>由上图我们可以看到，每次循环过后，读条就会增加。原理和数字的刷新一样，相信大家阅读代码就能理解，这里就不再赘述。</p>
<p>让我们来点更酷的吧！利用Ansi的光标<strong>向上</strong>以及<strong>向下</strong>的指令，我们还可以同时打印出多条进度条：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">loading</span><span class="params">(<span class="keyword">int</span> count)</span> <span class="keyword">throws</span> InterruptedException </span>{</div><div class="line">    System.out.print(String.join(<span class="string">""</span>, Collections.nCopies(count, <span class="string">"\n"</span>))); <span class="comment">// 初始化进度条所占的空间</span></div><div class="line">    List&lt;Integer&gt; allProgress = <span class="keyword">new</span> ArrayList&lt;&gt;(Collections.nCopies(count, <span class="number">0</span>));</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">        Thread.sleep(<span class="number">10</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 随机选择一个进度条，增加进度</span></div><div class="line">        List&lt;Integer&gt; unfinished = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; allProgress.size(); i++) {</div><div class="line">            <span class="keyword">if</span> (allProgress.get(i) &lt; <span class="number">100</span>) {</div><div class="line">                unfinished.add(i);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (unfinished.isEmpty()) {</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">int</span> index = unfinished.get(<span class="keyword">new</span> Random().nextInt(unfinished.size()));</div><div class="line">        allProgress.set(index, allProgress.get(index) + <span class="number">1</span>); <span class="comment">// 进度+1</span></div><div class="line"></div><div class="line">        <span class="comment">// 绘制进度条</span></div><div class="line">        System.out.print(<span class="string">"\u001b[1000D"</span>); <span class="comment">// 移动到最左边</span></div><div class="line">        System.out.print(<span class="string">"\u001b["</span> + count + <span class="string">"A"</span>); <span class="comment">// 往上移动</span></div><div class="line">        <span class="keyword">for</span> (Integer progress : allProgress) {</div><div class="line">            <span class="keyword">int</span> width = progress / <span class="number">4</span>;</div><div class="line">            String left = <span class="string">"["</span> + String.join(<span class="string">""</span>, Collections.nCopies(width, <span class="string">"#"</span>));</div><div class="line">            String right = String.join(<span class="string">""</span>, Collections.nCopies(<span class="number">25</span> - width, <span class="string">" "</span>)) + <span class="string">"]"</span>;</div><div class="line">            System.out.println(left + right);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p>在上述代码中：</p>
<ul>
<li>我们首先执行<code>System.out.print(String.join("", Collections.nCopies(count, "\n")));</code>打印出多个空行，这可以保证我们有足够的空间来打印进度条。</li>
<li>接下来我们随机增加一个进度条的进度，并且打印出所有进度条。</li>
<li>最后我们调用<strong>向上</strong>指令，将光标移回到最上方，继续下一个循环，直到所有进度条都到达100%。</li>
</ul>
<p>实际效果如下：</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-24-multi_bar_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-24-multi_bar_gif.gif" alt=""></a></p>
<p>效果真是太棒啦！剩下将读条和数字结合在一起的工作就交给读者啦。学会了这招，当你下次如果要做一个在命令行下载文件的小工具，这时候这些知识就派上用场啦！</p>
<h2 id="制作命令行"><a href="#制作命令行" class="headerlink" title="制作命令行"></a>制作命令行</h2><p>最后，最为酷炫的事情莫过于利用Ansi Escape Codes实现一个个性化的命令行（Command-Line）。我们平常使用的Bash以及一些解释型语言比如Python、Ruby等都有自己的REPL命令行。接下来，让我们揭开他们神秘的面纱，了解他们背后实现的原理。</p>
<blockquote>
<p>PS：由于在Jshell中，方向键、后退键等一些特殊键有自己的作用，所以接下来无法通过Jshell演示。需要自己手动进行编译运行代码才能看到实际效果。</p>
</blockquote>
<h3 id="一个最简单的命令行"><a href="#一个最简单的命令行" class="headerlink" title="一个最简单的命令行"></a>一个最简单的命令行</h3><p>首先，我们来实现一个最简单的命令行，简单到只实现下面两种功能：</p>
<ul>
<li>当用户输入一个可打印的字符时，比如abcd等，则在控制台显示。</li>
<li>当用户输入回车时，另起一行，输出刚才用户输入的所有字符，然后再另起一行，继续接受用户的输入。</li>
</ul>
<p>那么这个最简单的命令行的实现代码会长这样：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandLine</span> </span>{</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>{</div><div class="line">        <span class="comment">// 设置命令行为raw模式，否则会自动解析方向键以及后退键，并且直到按下回车read方法才会返回</span></div><div class="line">        String[] cmd = { <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"stty raw &lt;/dev/tty"</span> };</div><div class="line">        Runtime.getRuntime()</div><div class="line">               .exec(cmd)</div><div class="line">               .waitFor();</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">            String input = <span class="string">""</span>;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">                <span class="keyword">char</span> ch = (<span class="keyword">char</span>) System.in.read();</div><div class="line">                <span class="keyword">if</span> (ch == <span class="number">3</span>) {</div><div class="line">                    <span class="comment">// CTRL-C</span></div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch &gt;= <span class="number">32</span> &amp;&amp; ch &lt;= <span class="number">126</span>) {</div><div class="line">                    <span class="comment">// 普通字符</span></div><div class="line">                    input += ch;</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="number">10</span> || ch == <span class="number">13</span>) {</div><div class="line">                    <span class="comment">// 回车</span></div><div class="line">                    System.out.println();</div><div class="line">                    System.out.print(<span class="string">"\u001b[1000D"</span>);</div><div class="line">                    System.out.println(<span class="string">"echo: "</span> + input);</div><div class="line">                    input = <span class="string">""</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                System.out.print(<span class="string">"\u001b[1000D"</span>); <span class="comment">// 首先将光标移动到最左侧</span></div><div class="line">                System.out.print(input); <span class="comment">// 重新输出input</span></div><div class="line">                System.out.flush();</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p>好的，让我们来说明一下代码中的关键点：</p>
<ol>
<li><p>首先最关键的是我们需要将我们的命令行设置为raw模式，这可以避免JVM帮我们解析方向键，回退键以及对用户输入进行缓冲。大家可以试一下不设置raw模式然后看一下效果，就可以理解我说的话了。</p>
</li>
<li><p>通过<code>System.in.read()</code>方法获取用户输入，然后对其ascii值进行分析。</p>
</li>
<li><p>如果发现用户输入的是回车的话，我们这时需要打印刚才用户输入的所有字符。但是我们需要注意，由于设置了raw模式，不移动光标直接打印的话，光标的位置不会移到行首，如下图：</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-11-23-144321.png" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-11-23-144321.png" alt=""></a></p>
<p>所以这里需要再次调用<code>System.out.print("\u001b[1000D");</code>将光标移到行首。</p>
</li>
</ol>
<p>好了，让我们来看一下效果吧：</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-24-command_line_1_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-24-command_line_1_gif.gif" alt=""></a></p>
<p>成功了！但是有个缺点，那就是命令行并没有解析方向键，反而以<code>[D[A[C[B</code>输出（见动图）。这样我们只能一直往后面写而无法做到将光标移动到前面实现插入的效果。所以接下来就让我们给命令行加上解析方向键的功能吧！</p>
<h3 id="光标移动"><a href="#光标移动" class="headerlink" title="光标移动"></a>光标移动</h3><p>简单起见，我们仅需实现按下方向键的左右两键时能控制光标左右移动。左右两键对应的ascii码分别为<code>27 91 68</code>和<code>27 91 67</code>。所以我们只要在代码中加上对这两串ascii码的解析即可：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandLine</span> </span>{</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>{</div><div class="line">        <span class="comment">// 设置命令行为raw模式，否则会自动解析方向键以及后退键，并且直到按下回车read方法才会返回</span></div><div class="line">        String[] cmd = { <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"stty raw &lt;/dev/tty"</span> };</div><div class="line">        Runtime.getRuntime()</div><div class="line">               .exec(cmd)</div><div class="line">               .waitFor();</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">            String input = <span class="string">""</span>;</div><div class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">                <span class="keyword">char</span> ch = (<span class="keyword">char</span>) System.in.read();</div><div class="line">                <span class="keyword">if</span> (ch == <span class="number">3</span>) {</div><div class="line">                    <span class="comment">// CTRL-C</span></div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch &gt;= <span class="number">32</span> &amp;&amp; ch &lt;= <span class="number">126</span>) {</div><div class="line">                    <span class="comment">// 普通字符</span></div><div class="line">                    input = input.substring(<span class="number">0</span>, index) + ch + input.substring(index, input.length());</div><div class="line">                    index++;</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="number">10</span> || ch == <span class="number">13</span>) {</div><div class="line">                    <span class="comment">// 回车</span></div><div class="line">                    System.out.println();</div><div class="line">                    System.out.print(<span class="string">"\u001b[1000D"</span>);</div><div class="line">                    System.out.println(<span class="string">"echo: "</span> + input);</div><div class="line">                    input = <span class="string">""</span>;</div><div class="line">                    index = <span class="number">0</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="number">27</span>) {</div><div class="line">                    <span class="comment">// 左右方向键</span></div><div class="line">                    <span class="keyword">char</span> next1 = (<span class="keyword">char</span>) System.in.read();</div><div class="line">                    <span class="keyword">char</span> next2 = (<span class="keyword">char</span>) System.in.read();</div><div class="line">                    <span class="keyword">if</span> (next1 == <span class="number">91</span>) {</div><div class="line">                        <span class="keyword">if</span> (next2 == <span class="number">68</span>) {</div><div class="line">                            <span class="comment">// 左方向键</span></div><div class="line">                            index = Math.max(<span class="number">0</span>, index - <span class="number">1</span>);</div><div class="line">                        }</div><div class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (next2 == <span class="number">67</span>) {</div><div class="line">                            <span class="comment">// 右方向键</span></div><div class="line">                            index = Math.min(input.length(), index + <span class="number">1</span>);</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line">                System.out.print(<span class="string">"\u001b[1000D"</span>); <span class="comment">// 将光标移动到最左侧</span></div><div class="line">                System.out.print(input);</div><div class="line">                System.out.print(<span class="string">"\u001b[1000D"</span>); <span class="comment">// 再次将光标移动到最左侧</span></div><div class="line">                <span class="keyword">if</span> (index &gt; <span class="number">0</span>) {</div><div class="line">                    System.out.print(<span class="string">"\u001b["</span> + index + <span class="string">"C"</span>); <span class="comment">// 将光标移动到index处</span></div><div class="line">                }</div><div class="line">                System.out.flush();</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-24-command_line_arrow_key_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-24-command_line_arrow_key_gif.gif" alt=""></a></p>
<p>It works！但是这个命令行还不支持删除，我们无法通过<code>Backspace</code>键删去敲错的字符。有了刚才的经验，实现删除功能也十分简单！</p>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>照着刚才的思路，我们可能会在处理用户输入的地方，加上如下的代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="number">127</span>) {</div><div class="line">    <span class="comment">// 删除</span></div><div class="line">    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) {</div><div class="line">        input = input.substring(<span class="number">0</span>, index - <span class="number">1</span>) + input.substring(index, input.length());</div><div class="line">        index -= <span class="number">1</span>;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p>但是这段代码存在点问题，让我们看一下效果图：</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-26-delete_one_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-26-delete_one_gif.gif" alt=""></a></p>
<p>从图中我们可以看到：</p>
<ul>
<li>第一次，当我输入了<code>11234566</code>，然后不停地按下删除键，想要删掉<code>34566</code>，但是只有光标在后退，字符并没有被删掉。然后我再按下回车键，通过echo的字符串我们发现删除实际上已经成功，只是控制台在显示的时候出了点问题。</li>
<li>第二次，我先输入<code>123456</code>，然后按下删除键，删掉<code>456</code>，光标退到<code>3</code>。然后我再继续不断地输入<code>0</code>，我们发现随着<code>0</code>覆盖了原来的<code>456</code>显示的位置。</li>
</ul>
<p>所以删除的确产生了效果，但是我们要解决被删除的字符还在显示的这个bug。为了实现删除的效果，我们先来学习一下Ansi里的删除指令：</p>
<ul>
<li>清除屏幕：<code>\u001b[{n}J</code>为指令。<ul>
<li><code>n=0</code>：清除光标到屏幕末尾的所有字符。</li>
<li><code>n=1</code>：清除屏幕开头到光标的所有字符。</li>
<li><code>n=2</code>：清除整个屏幕的字符。</li>
</ul>
</li>
<li>清除行：<code>\u001b[{n}K</code>为指令。<ul>
<li><code>n=0</code>：清除光标到当前行末所有的字符。</li>
<li><code>n=1</code>：清除当前行到光标的所有字符。</li>
<li><code>n=2</code>：清除当前行。</li>
</ul>
</li>
</ul>
<p>所以我们的思路就是不管用户输入了什么，我们先利用<code>System.out.print("\u001b[0K");</code>清除当前行，此时光标回到了行首，这时再输出正确的字符。完整代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandLine</span> </span>{</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>{</div><div class="line">        <span class="comment">// 设置命令行为raw模式，否则会自动解析方向键以及后退键，并且直到按下回车read方法才会返回</span></div><div class="line">        String[] cmd = { <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"stty raw &lt;/dev/tty"</span> };</div><div class="line">        Runtime.getRuntime()</div><div class="line">               .exec(cmd)</div><div class="line">               .waitFor();</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">            String input = <span class="string">""</span>;</div><div class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">                <span class="keyword">char</span> ch = (<span class="keyword">char</span>) System.in.read();</div><div class="line">                <span class="keyword">if</span> (ch == <span class="number">3</span>) {</div><div class="line">                    <span class="comment">// CTRL-C</span></div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch &gt;= <span class="number">32</span> &amp;&amp; ch &lt;= <span class="number">126</span>) {</div><div class="line">                    <span class="comment">// 普通字符</span></div><div class="line">                    input = input.substring(<span class="number">0</span>, index) + ch + input.substring(index, input.length());</div><div class="line">                    index++;</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="number">10</span> || ch == <span class="number">13</span>) {</div><div class="line">                    <span class="comment">// 回车</span></div><div class="line">                    System.out.println();</div><div class="line">                    System.out.print(<span class="string">"\u001b[1000D"</span>);</div><div class="line">                    System.out.println(<span class="string">"echo: "</span> + input);</div><div class="line">                    input = <span class="string">""</span>;</div><div class="line">                    index = <span class="number">0</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="number">27</span>) {</div><div class="line">                    <span class="comment">// 左右方向键</span></div><div class="line">                    <span class="keyword">char</span> next1 = (<span class="keyword">char</span>) System.in.read();</div><div class="line">                    <span class="keyword">char</span> next2 = (<span class="keyword">char</span>) System.in.read();</div><div class="line">                    <span class="keyword">if</span> (next1 == <span class="number">91</span>) {</div><div class="line">                        <span class="keyword">if</span> (next2 == <span class="number">68</span>) {</div><div class="line">                            <span class="comment">// 左方向键</span></div><div class="line">                            index = Math.max(<span class="number">0</span>, index - <span class="number">1</span>);</div><div class="line">                        }</div><div class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (next2 == <span class="number">67</span>) {</div><div class="line">                            <span class="comment">// 右方向键</span></div><div class="line">                            index = Math.min(input.length(), index + <span class="number">1</span>);</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="number">127</span>) {</div><div class="line">                    <span class="comment">// 删除</span></div><div class="line">                    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) {</div><div class="line">                        input = input.substring(<span class="number">0</span>, index - <span class="number">1</span>) + input.substring(index, input.length());</div><div class="line">                        index -= <span class="number">1</span>;</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                System.out.print(<span class="string">"\u001b[1000D"</span>); <span class="comment">// 将光标移动到最左侧</span></div><div class="line">                System.out.print(<span class="string">"\u001b[0K"</span>); <span class="comment">// 清除光标所在行的全部内容</span></div><div class="line">                System.out.print(input);</div><div class="line">                System.out.print(<span class="string">"\u001b[1000D"</span>); <span class="comment">// 再次将光标移动到最左侧</span></div><div class="line">                <span class="keyword">if</span> (index &gt; <span class="number">0</span>) {</div><div class="line">                    System.out.print(<span class="string">"\u001b["</span> + index + <span class="string">"C"</span>); <span class="comment">// 将光标移动到index处</span></div><div class="line">                }</div><div class="line">                System.out.flush();</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></tbody></table></figure>
<p>让我们来看一下效果：</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-27-right_delete_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-27-right_delete_gif.gif" alt=""></a></p>
<p>OK，成功了！那么至此为止，我们已经实现了一个最小化的命令行，它能够支持用户进行输入，并且能够左右移动光标以及删除他不想要的字符。但是它还缺失了很多命令行的特性，比如不支持解析像<code>Alt-f</code>、<code>Ctrl-r</code>等常见的<a href="http://www.bigsmoke.us/readline/shortcuts" target="_blank" rel="external">快捷键</a>，也不支持输入Unicode字符等等。但是，只要我们掌握了刚才的知识，这些特性都可以方便地实现。比如，我们可以给刚才的命令行加上简单的语法高亮——末尾如果有多余的空格则将这些空格标红，效果如下：</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-27-syntax_gif.gif" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-09-27-syntax_gif.gif" alt=""></a></p>
<p>实现的代码也很简单，可以参考Github项目里的CustomisedCommandLine类。</p>
<p>最后，再介绍一下其他一些有用的Ansi Escape Codes：</p>
<ul>
<li>光标向上移动：<code>\u001b[{n}A</code>将光标向上移动<code>n</code>格。</li>
<li>光标向下移动：<code>\u001b[{n}B</code>将光标向下移动<code>n</code>格。</li>
<li>光标向右移动：<code>\u001b[{n}C</code>将光标向右移动<code>n</code>格。</li>
<li>光标向左移动：<code>\u001b[{n}D</code>将光标向左移动<code>n</code>格。</li>
<li>光标按行向下移动：<code>\u001b[{n}E</code>将光标向下移动<code>n</code>行并且将光标移至行首。</li>
<li>光标按行向上移动：<code>\u001b[{n}F</code>将光标向上移动<code>n</code>行并且将光标移至行首。</li>
<li>设置光标所在列：<code>\u001b[{n}G</code>将光标移至第<code>n</code>列（行数与当前所在行保持一致）。</li>
<li>设置光标所在位置：<code>\u001b[{n};{m}H</code>将光标移至第<code>n</code>行<code>m</code>列，坐标原点从屏幕左上角开始。</li>
<li>保存光标当前所在位置：<code>\u001b[{s}</code>。</li>
<li>读取光标上一次保存的位置：<code>\u001b[{u}</code>。</li>
</ul>
<p>光标按行移动的测试代码参考Github项目里的LineMovementTest类，设置光标位置的测试代码参考Github项目里的PositionTest类。如果想了解更多的Ansi Escape Codes请参考<a href="https://en.wikipedia.org/wiki/ANSI_escape_code#CSI_codes" target="_blank" rel="external">维基百科</a>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过本文的学习，我相信大家已经掌握了如何通过Ansi Escape Codes实现控制台的富文本输出以及控制台光标的自定义移动。那么文章一开始的那4个好奇，大家心中是否已经有了答案了呢？最后，还是强烈建议英文好的同学去阅读一下原文：<a href="http://www.lihaoyi.com/post/BuildyourownCommandLinewithANSIescapecodes.html" target="_blank" rel="external">http://www.lihaoyi.com/post/BuildyourownCommandLinewithANSIescapecodes.html</a>。祝大家周末愉快！</p>
<p><a href="http://7xrd8h.com1.z0.glb.clouddn.com/2017-11-25-015617.png" class="fancybox fancybox.image" rel="group"><img src="http://7xrd8h.com1.z0.glb.clouddn.com/2017-11-25-015617.png" alt=""></a></p>
</div>