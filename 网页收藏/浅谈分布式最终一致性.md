# 浅谈分布式最终一致性


可以选择分布式事务框架方案，目前主流的分布式事务框架大致可分为3类实现 :基于XA协议的两阶段提交(2PC)方案基于支付宝最早提出的TCC(Try、Confirm、Cancel)方案基于ebay最早提出的消息队列异步确保方案

此外还有较轻的解决方案，业务系统可以根据自身需要，选择通过幂等/重试、状态机、恢复日志、异步校验等技术来确保最终一致性。

重型武器
采用分布式事务框架的方案，最终一致性由分布式事务框架保证，业务程序员对框架细节完全透明

轻型武器
不同于采用分布式事务框架的最终一致性方案，程序员也可以选择通过幂等/重试、状态机、恢复日志、异步校验等技术来确保最终一致性。不过这种方案对业务开发的要求更高，分布式一致性逻辑要业务程序员代码实现，容易出现bug

实践

1. 重试
    重试机制可以使分布式不一致数据自动恢复，前提是重试接口要提供幂等保证。

    - 同步重试 : 在上次请求失败或超时，程序再次发起同步调用请求。后端程序不推荐同步重试，其一因为同步等待占用系统线程资源，其二因为重试引起的流量放大，可能导致系统雪崩。
    - 异步重试 : 通过异步系统(消息队列或调度中间件)对失败或超时请求再次发起调用。推荐这种方式的重试，重试的时间间隔可以设置为根据重试次数指数增长，超过重试阈值仍未成功，可以报警通知并由人工订正。

2. 幂等
    用通俗的话来说就是 : 相同的操作执行多次 和 执行一次产生的效果是一样的。
    - 基于记录的悲观锁
        加锁和更新记录在同一个事务中，长时间锁定记录会降低系统的TPS，高并发场景不推荐使用。
    - 基于记录版本号或状态机的乐观锁方案，适用于更新数据场景。
    - 基于数据库唯一索引的去重表，适用于插入和更新数据的场景，由数据库惟一索引确保多次插入和更新操作只有一次生效。
    - 基于全局唯一标识token实现

3. 状态机
    通过状态机模型，系统可以判断当前不一致状态，以及如何校正不一致状态到一致状态

4. 恢复日志
    恢复日志是程序现场的记录，也是业务数据恢复的重要依据。恢复日志log要求全局唯一的requestId来标示请求，丢失恢复日志，意味着不一致可能无法恢复。为什么是可能，因为有时可以通过状态机对不一致的状态进行恢复。

5. 异步校验
    我们只要在业务系统外部加上严格的业务约束，用来仲裁业务系统的状态。通过异步校验，可以发现分布式系统中的异常状态，并通过恢复日志进行脚本批量恢复或者人工处理恢复

[浅谈分布式最终一致性][1]

[1]: https://mp.weixin.qq.com/s/avoJsoKy88WkWnxAid-OQw
